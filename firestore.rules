rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Kullanıcı profilleri
    match /users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;

      // Favoriler subcollection - sadece kullanıcı kendi favorilerini yönetebilir
      match /favorites/{favoriteId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // Etkinlikler
    match /events/{eventId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null &&
        resource.data.organizerId == request.auth.uid;

      // Servis operasyonları subcollection - organizatör ve ilgili provider erişebilir
      match /serviceOperations/{serviceId} {
        allow read, write: if request.auth != null;
      }
    }

    // Provider'lar
    match /providers/{providerId} {
      allow read: if true;
      allow write: if request.auth != null &&
        resource.data.userId == request.auth.uid;
    }

    // Sanatçılar
    match /artists/{artistId} {
      allow read: if true;
      allow write: if request.auth != null;

      // Sanatçı ekip üyeleri subcollection
      match /team/{memberId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null;
      }

      // Sanatçı rider dosyaları subcollection
      match /riders/{riderId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null;
      }
    }

    // Teklifler / Talepler
    match /offers/{offerId} {
      // Organizatör veya provider kendi tekliflerini okuyabilir
      allow read: if request.auth != null && (
        resource.data.organizerId == request.auth.uid ||
        resource.data.providerId == request.auth.uid
      );
      // Herkes teklif talebi oluşturabilir
      allow create: if request.auth != null;
      // Sadece ilgili taraflar güncelleyebilir
      allow update: if request.auth != null && (
        resource.data.organizerId == request.auth.uid ||
        resource.data.providerId == request.auth.uid
      );
      // Sadece organizatör silebilir
      allow delete: if request.auth != null &&
        resource.data.organizerId == request.auth.uid;
    }

    // Sohbetler
    match /conversations/{conversationId} {
      // Kullanıcı sadece katılımcı olduğu sohbetleri okuyabilir
      allow read: if request.auth != null &&
        request.auth.uid in resource.data.participantIds;

      // Yeni sohbet oluşturma - kullanıcı katılımcı listesinde olmalı
      allow create: if request.auth != null &&
        request.auth.uid in request.resource.data.participantIds;

      // Güncelleme - sadece katılımcılar
      allow update: if request.auth != null &&
        request.auth.uid in resource.data.participantIds;

      // Mesajlar subcollection
      match /messages/{messageId} {
        allow read: if request.auth != null &&
          request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participantIds;
        allow create: if request.auth != null &&
          request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participantIds;
      }
    }

    // Eski messages koleksiyonu (geriye uyumluluk)
    match /messages/{messageId} {
      allow read, write: if request.auth != null;
    }

    // Doğrulama kodları - sadece Cloud Functions erişebilir
    match /verificationCodes/{codeId} {
      allow read, write: if false;
    }

    // Etkinlik değişiklik talepleri
    match /eventRevisions/{revisionId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth != null;
    }
  }
}
